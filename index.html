<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Регистрация участника</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{
  max-width:420px;background:#fff;padding:20px;margin:auto;
  border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1)
}
.logo img{max-width:160px;display:block;margin:auto}
label{font-weight:bold;margin-top:12px;display:block}
input,button{width:100%;padding:10px;margin-top:5px;font-size:16px}
button{background:#1976d2;color:#fff;border:none;border-radius:5px}
.select{position:relative}
.list{
  position:absolute;width:100%;background:#fff;border:1px solid #ccc;
  max-height:180px;overflow:auto;display:none;z-index:10
}
.item{padding:8px;cursor:pointer}
.item:hover{background:#1976d2;color:#fff}
.success{color:green;text-align:center;margin-top:10px}
.error{color:red;text-align:center;margin-top:10px}
</style>
</head>

<body>
<div class="container">

<div class="logo">
<img src="https://raw.githubusercontent.com/cmrito2020-web/cmrito/main/logo%20new%20alpha.png">
</div>

<form id="form">

<label>Район *</label>
<div class="select">
  <input id="district" readonly placeholder="Выберите район">
  <div id="districtList" class="list"></div>
</div>

<label>ФИО *</label>
<div class="select">
  <input id="fio" placeholder="Выберите или введите ФИО">
  <div id="fioList" class="list"></div>
</div>

<label>Учреждение *</label>
<div class="select">
  <input id="org" placeholder="Выберите или введите учреждение">
  <div id="orgList" class="list"></div>
</div>

<button type="submit">Отправить</button>
</form>

<div id="msg"></div>
</div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/cmrito2020-web/cmrito/main/data.csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-SzEGV6nJz-QheTCd-UrldJ23-eF_hsm5oQMwHHMoRxNZa1EFCtL0lMhCeWIFK8Y/exec";

const district = document.getElementById("district");
const fio = document.getElementById("fio");
const org = document.getElementById("org");

const districtList = document.getElementById("districtList");
const fioList = document.getElementById("fioList");
const orgList = document.getElementById("orgList");
const msg = document.getElementById("msg");

let db = [];

// ===== ЗАГРУЗКА CSV =====
fetch(CSV_URL).then(r=>r.text()).then(t=>{
  const rows = t.trim().split("\n").slice(1);
  db = rows
    .map(r => r.split(","))
    .filter(c => (c[1] || "").trim() !== "") // ФИО обязательно
    .map(c => ({
      district: (c[0] || "").trim(),
      fio: (c[1] || "").trim(),
      org: (c[2] || "").trim()
    }));
  loadDistricts();
});

// ===== РАЙОН =====
function loadDistricts(){
  const list=[...new Set(db.map(x=>x.district).filter(x=>x))].sort();
  districtList.innerHTML="";
  list.forEach(v=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=v;
    d.onclick=()=>{
      district.value=v;
      districtList.style.display="none";
      fio.value="";
      org.value="";
    };
    districtList.appendChild(d);
  });
}
district.onclick=()=>districtList.style.display="block";

// ===== ФИО (ПО РАЙОНУ + ОБЩИЕ БЕЗ РАЙОНА) =====
fio.oninput=()=>{
  fioList.innerHTML="";
  orgList.style.display="none";

  if(!district.value) return;

  const q = fio.value.toLowerCase();

  // 1) ФИО выбранного района
  const listByDistrict = db.filter(x =>
    x.district === district.value &&
    x.fio.toLowerCase().includes(q)
  );

  // 2) Общие ФИО без района (district пустой)
  const listNoDistrict = db.filter(x =>
    !x.district &&
    x.fio.toLowerCase().includes(q)
  );

  // Склеиваем + убираем дубликаты по ФИО
  const mergedMap = new Map();
  [...listByDistrict, ...listNoDistrict].forEach(x => {
    if (!mergedMap.has(x.fio)) mergedMap.set(x.fio, x);
  });

  const merged = Array.from(mergedMap.values());

  merged.forEach(x=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent = x.fio + (x.district ? "" : " (общий)");
    d.onclick=()=>{
      fio.value = x.fio;
      // подставим организацию если есть
      if (x.org) org.value = x.org;
      fioList.style.display="none";
    };
    fioList.appendChild(d);
  });

  fioList.style.display = merged.length ? "block" : "none";
};

// ===== УЧРЕЖДЕНИЕ (ПО РАЙОНУ + ОБЩИЕ БЕЗ РАЙОНА) =====
org.oninput=()=>{
  orgList.innerHTML="";
  if(!district.value) return;

  const q = org.value.toLowerCase();

  const orgsByDistrict = db
    .filter(x => x.district === district.value && x.org)
    .map(x => x.org);

  const orgsNoDistrict = db
    .filter(x => !x.district && x.org)
    .map(x => x.org);

  const uniq = [...new Set([...orgsByDistrict, ...orgsNoDistrict])]
    .filter(v => v.toLowerCase().includes(q))
    .sort();

  uniq.forEach(v=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=v;
    d.onclick=()=>{
      org.value=v;
      orgList.style.display="none";
    };
    orgList.appendChild(d);
  });

  orgList.style.display = uniq.length ? "block" : "none";
};

// ===== ОТПРАВКА =====
document.getElementById("form").onsubmit=e=>{
  e.preventDefault();

  if(!district.value.trim() || !fio.value.trim() || !org.value.trim()){
    msg.innerHTML="<div class='error'>❗ Заполните все поля</div>";
    return;
  }

  const fd=new FormData();
  fd.append("district",district.value.trim());
  fd.append("fio",fio.value.trim());
  fd.append("organization",org.value.trim());

  fetch(SCRIPT_URL,{method:"POST",body:fd})
    .then(r=>r.text())
    .then(t=>{
      msg.innerHTML = t==="OK"
        ?"<div class='success'>✅ Данные сохранены</div>"
        :"<div class='error'>❌ Ошибка</div>";
    });
};
</script>
</body>
</html>
