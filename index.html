<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{
  max-width:420px;background:#fff;padding:20px;margin:auto;
  border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1)
}
.logo img{max-width:160px;display:block;margin:auto}
label{font-weight:bold;margin-top:12px;display:block}
input{
  width:90%;
  padding:10px;
  margin-top:5px;
  font-size:16px
}
button{
  display:block;
  margin:20px auto 0;
  padding:10px 40px;
  font-size:16px;
  background:#1976d2;
  color:#fff;
  border:none;
  border-radius:5px;
}
.select{position:relative}
.list{
  position:absolute;width:100%;background:#fff;border:1px solid #ccc;
  max-height:180px;overflow:auto;display:none;z-index:10
}
.item{padding:8px;cursor:pointer}
.item:hover{background:#1976d2;color:#fff}
.success{color:green;text-align:center;margin-top:10px}
.error{color:red;text-align:center;margin-top:10px}
</style>
</head>

<body>
<div class="container">

<div class="logo">
<img src="https://raw.githubusercontent.com/cmrito2020-web/cmrito/main/logo%20new%20alpha.png">
</div>
<h2 style="text-align:center">–¢—ñ—Ä–∫–µ—É</h2>
<form id="form">

<!-- –†–ê–ô–û–ù -->
<label>–ê—É–¥–∞–Ω *</label>
<div class="select">
  <input id="district" readonly placeholder="–ê–π–º–∞“õ—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑">
  <div id="districtList" class="list"></div>
</div>

<!-- –§–ò–û -->
<label>–¢–µ–≥—ñ –ê—Ç—ã ”ò–∫–µ—Å—ñ–Ω—ñ“£ –ê—Ç—ã *</label>
<div class="select">
  <input id="fio" placeholder="–ê—Ç—ã –∂”©–Ω—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑ –Ω–µ–º–µ—Å–µ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
  <div id="fioList" class="list"></div>
</div>

<!-- –£–ß–†–ï–ñ–î–ï–ù–ò–ï -->
<label>–ë—ñ–ª—ñ–º –±–µ—Ä—É “±–π—ã–º—ã *</label>
<div class="select">
  <input id="org" placeholder="–ú–µ–∫–µ–º–µ–Ω—ñ —Ç–∞“£–¥–∞“£—ã–∑ –Ω–µ–º–µ—Å–µ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
  <div id="orgList" class="list"></div>
</div>

<button type="submit">–ñ—ñ–±–µ—Ä—É</button>
</form>

<div id="msg"></div>
</div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/cmrito2020-web/cmrito/main/data.csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-SzEGV6nJz-QheTCd-UrldJ23-eF_hsm5oQMwHHMoRxNZa1EFCtL0lMhCeWIFK8Y/exec";

const district = document.getElementById("district");
const fio = document.getElementById("fio");
const org = document.getElementById("org");

const districtList = document.getElementById("districtList");
const fioList = document.getElementById("fioList");
const orgList = document.getElementById("orgList");
const msg = document.getElementById("msg");

let db = [];

// ===== –ó–ê–ì–†–£–ó–ö–ê CSV =====
fetch(CSV_URL)
  .then(r=>r.text())
  .then(t=>{
    const rows = t.trim().split("\n").slice(1);
    db = rows
      .map(r=>r.split(","))
      .filter(c => (c[1]||"").trim() !== "")
      .map(c=>({
        district:(c[0]||"").trim(),
        fio:(c[1]||"").trim(),
        org:(c[2]||"").trim()
      }));
    loadDistricts();
  });

// ===== –†–ê–ô–û–ù =====
function loadDistricts(){
  const list=[...new Set(db.map(x=>x.district).filter(x=>x))].sort();
  districtList.innerHTML="";
  list.forEach(v=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=v;
    d.onclick=()=>{
      district.value=v;
      districtList.style.display="none";
      fio.value="";
      org.value="";
    };
    districtList.appendChild(d);
  });
}
district.onclick=()=>districtList.style.display="block";

// ===== –§–ò–û (–ü–û –†–ê–ô–û–ù–£ + –û–ë–©–ò–ï) =====
function showFioList(){
  fioList.innerHTML="";
  orgList.style.display="none";

  if(!district.value) return;

  const q=fio.value.toLowerCase();

  const byDistrict = db.filter(x =>
    x.district===district.value &&
    x.fio.toLowerCase().includes(q)
  );

  const common = db.filter(x =>
    !x.district &&
    x.fio.toLowerCase().includes(q)
  );

  const map=new Map();
  [...byDistrict, ...common].forEach(x=>{
    if(!map.has(x.fio)) map.set(x.fio,x);
  });

  const merged=[...map.values()];

  merged.forEach(x=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=x.fio + (x.district ? "" : " (—Å–ø–∏–∫–µ—Ä)");
    d.onclick=()=>{
      fio.value=x.fio;
      if(x.org) org.value=x.org;
      fioList.style.display="none";
    };
    fioList.appendChild(d);
  });

  fioList.style.display = merged.length ? "block" : "none";
}

// üîß –í–ê–ñ–ù–û: –∏ –ø—Ä–∏ –≤–≤–æ–¥–µ, –∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
fio.oninput = showFioList;
fio.onclick = showFioList;

// ===== –£–ß–†–ï–ñ–î–ï–ù–ò–ï (–ü–û –†–ê–ô–û–ù–£ + –û–ë–©–ò–ï) =====
function showOrgList(){
  orgList.innerHTML="";
  if(!district.value) return;

  const q=org.value.toLowerCase();

  const byDistrict=db
    .filter(x=>x.district===district.value && x.org)
    .map(x=>x.org);

  const common=db
    .filter(x=>!x.district && x.org)
    .map(x=>x.org);

  const uniq=[...new Set([...byDistrict,...common])]
    .filter(v=>v.toLowerCase().includes(q))
    .sort();

  uniq.forEach(v=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=v;
    d.onclick=()=>{
      org.value=v;
      orgList.style.display="none";
    };
    orgList.appendChild(d);
  });

  orgList.style.display = uniq.length ? "block" : "none";
}

org.oninput = showOrgList;
org.onclick = showOrgList;

// ===== –û–¢–ü–†–ê–í–ö–ê =====
document.getElementById("form").onsubmit=e=>{
  e.preventDefault();

  if(!district.value.trim() || !fio.value.trim() || !org.value.trim()){
    msg.innerHTML="<div class='error'>‚ùó –ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑</div>";
    return;
  }

  const fd=new FormData();
  fd.append("district",district.value.trim());
  fd.append("fio",fio.value.trim());
  fd.append("organization",org.value.trim());

  fetch(SCRIPT_URL,{method:"POST",body:fd})
    .then(r=>r.text())
    .then(t=>{
      msg.innerHTML = t==="OK"
        ? "<div class='success'>‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä —Å–∞“õ—Ç–∞–ª–¥—ã</div>"
        : "<div class='error'>‚ùå “ö–∞—Ç–µ</div>";
    });
};
</script>
</body>
</html>
